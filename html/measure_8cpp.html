<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SapFlow Probe: measure.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SapFlow Probe
   </div>
   <div id="projectbrief">A low-cost HRM probe for measuring a tree&#39;s water consumption</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('measure_8cpp.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">measure.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="measure_8h_source.html">measure.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="lora_8h_source.html">lora.h</a>&quot;</code><br />
</div>
<p><a href="measure_8cpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a4077648d56901b090710a429b69fe19d"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8cpp.html#a4077648d56901b090710a429b69fe19d">sample_timer</a> (struct pt *pt)</td></tr>
<tr class="memdesc:a4077648d56901b090710a429b69fe19d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Controls timing of the measurements.  <a href="measure_8cpp.html#a4077648d56901b090710a429b69fe19d">More...</a><br /></td></tr>
<tr class="separator:a4077648d56901b090710a429b69fe19d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a657b44bae6694e6e2c5477f4f2ab85a1"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8cpp.html#a657b44bae6694e6e2c5477f4f2ab85a1">measure</a> (struct pt *pt)</td></tr>
<tr class="memdesc:a657b44bae6694e6e2c5477f4f2ab85a1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Captures a measurement from the three probes.  <a href="measure_8cpp.html#a657b44bae6694e6e2c5477f4f2ab85a1">More...</a><br /></td></tr>
<tr class="separator:a657b44bae6694e6e2c5477f4f2ab85a1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a31cf8d05fcffa8f51508a9c3db637413"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8cpp.html#a31cf8d05fcffa8f51508a9c3db637413">baseline</a> (struct pt *pt)</td></tr>
<tr class="memdesc:a31cf8d05fcffa8f51508a9c3db637413"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates baseline temperature.  <a href="measure_8cpp.html#a31cf8d05fcffa8f51508a9c3db637413">More...</a><br /></td></tr>
<tr class="separator:a31cf8d05fcffa8f51508a9c3db637413"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa831fa3620094ac2be9c85d34a89051e"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="measure_8cpp.html#aa831fa3620094ac2be9c85d34a89051e">delta</a> (struct pt *pt)</td></tr>
<tr class="memdesc:aa831fa3620094ac2be9c85d34a89051e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates temperature delta and sapflow.  <a href="measure_8cpp.html#aa831fa3620094ac2be9c85d34a89051e">More...</a><br /></td></tr>
<tr class="separator:aa831fa3620094ac2be9c85d34a89051e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ae5efd21d6417fda5e3f0cfccf1d1301b"><td class="memItemLeft" align="right" valign="top"><a id="ae5efd21d6417fda5e3f0cfccf1d1301b"></a>
float&#160;</td><td class="memItemRight" valign="bottom"><b>maxtemp</b></td></tr>
<tr class="separator:ae5efd21d6417fda5e3f0cfccf1d1301b"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a31cf8d05fcffa8f51508a9c3db637413"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a31cf8d05fcffa8f51508a9c3db637413">&#9670;&nbsp;</a></span>baseline()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int baseline </td>
          <td>(</td>
          <td class="paramtype">struct pt *&#160;</td>
          <td class="paramname"><em>pt</em> = <code>&amp;<a class="el" href="measure_8h.html#a75797b818bbb902f6d65e98df6ed77f1">baseline_thd</a></code></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculates baseline temperature. </p>
<p>This is a protothread that averages 10 samples of data to determine the "initial" or "baseline" temperature of the tree. It should be used before the heater is turned on.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pt</td><td>A pointer to the protothread control structure. The default parameter is correct. Don't forget to initialize the control structure in <a class="el" href="sapflow__protothread_8ino.html#a4fc01d736fe50cf5b977f755b675f11d" title="One-time initialization.">setup()</a>. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the status of the protothread (Waiting, yeilded, exited, or ended) </dd></dl>

<p class="definition">Definition at line <a class="el" href="measure_8cpp_source.html#l00065">65</a> of file <a class="el" href="measure_8cpp_source.html">measure.cpp</a>.</p>

<p class="reference">References <a class="el" href="measure_8h_source.html#l00021">temperature::lower</a>, <a class="el" href="measure_8h_source.html#l00026">reference</a>, and <a class="el" href="measure_8h_source.html#l00020">temperature::upper</a>.</p>

<p class="reference">Referenced by <a class="el" href="schedule_8cpp_source.html#l00080">schedule()</a>.</p>

</div>
</div>
<a id="aa831fa3620094ac2be9c85d34a89051e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa831fa3620094ac2be9c85d34a89051e">&#9670;&nbsp;</a></span>delta()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int delta </td>
          <td>(</td>
          <td class="paramtype">struct pt *&#160;</td>
          <td class="paramname"><em>pt</em> = <code>&amp;<a class="el" href="measure_8h.html#a8ff6579d0f5410dbe20162392e32d3a4">delta_thd</a></code></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculates temperature delta and sapflow. </p>
<p>This is a protothread that calculates the sap flow by averaging measurements over 40 seconds. It also calls other functions to get the weight, package the data, log to an SD card, and send the information over LoRa.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pt</td><td>A pointer to the protothread control structure. The default parameter is correct. Don't forget to initialize the control structure in <a class="el" href="sapflow__protothread_8ino.html#a4fc01d736fe50cf5b977f755b675f11d" title="One-time initialization.">setup()</a>. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the status of the protothread (Waiting, yeilded, exited, or ended) </dd></dl>
<p>We compute sapflow using the following formula:: sapflow = k / x * log(v1 / v2) / 3600</p>
<ul>
<li>k is an empirical constant</li>
<li>x is the distance between the probes</li>
<li>v1 is temperature increase of the upper probe from its baseline temperature</li>
<li>v2 is the temperature increase of the lower probe from its baseline temperature</li>
<li>3600 is the number of seconds in an hour</li>
</ul>
<p>In order to get a smoother result, we are takng the average of this calculation over a period of 40 seconds. Burges et. al. (2001) suggests that this value should converge.</p>

<p class="definition">Definition at line <a class="el" href="measure_8cpp_source.html#l00091">91</a> of file <a class="el" href="measure_8cpp_source.html">measure.cpp</a>.</p>

<p class="reference">References <a class="el" href="lora_8cpp_source.html#l00058">build_msg()</a>, <a class="el" href="sd__log_8h.html#ab9da93331bae3f5268bcaf01ab44d31d">cout()</a>, <a class="el" href="measure_8h_source.html#l00025">latest</a>, <a class="el" href="lora_8cpp_source.html#l00017">lora_init()</a>, <a class="el" href="measure_8h_source.html#l00021">temperature::lower</a>, <a class="el" href="measure_8h_source.html#l00026">reference</a>, <a class="el" href="schedule_8h_source.html#l00010">rtc_ds</a>, <a class="el" href="measure_8h_source.html#l00009">sample_trigger</a>, and <a class="el" href="measure_8h_source.html#l00020">temperature::upper</a>.</p>

<p class="reference">Referenced by <a class="el" href="schedule_8cpp_source.html#l00080">schedule()</a>.</p>

</div>
</div>
<a id="a657b44bae6694e6e2c5477f4f2ab85a1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a657b44bae6694e6e2c5477f4f2ab85a1">&#9670;&nbsp;</a></span>measure()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int measure </td>
          <td>(</td>
          <td class="paramtype">struct pt *&#160;</td>
          <td class="paramname"><em>pt</em> = <code>&amp;<a class="el" href="measure_8h.html#ada9fca85b63952a68f6a2158e5f8a87b">measure_thd</a></code></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Captures a measurement from the three probes. </p>
<p>This is a protothread that reads the temperature from three RTD amplifiers connected to the probes in the tree. It stores the result in the global variable "latest", and logs to the SD card.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pt</td><td>A pointer to the protothread control structure. The default parameter is correct. Don't forget to initialize the control structure in <a class="el" href="sapflow__protothread_8ino.html#a4fc01d736fe50cf5b977f755b675f11d" title="One-time initialization.">setup()</a>. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the status of the protothread (Waiting, yeilded, exited, or ended) </dd></dl>

<p class="definition">Definition at line <a class="el" href="measure_8cpp_source.html#l00022">22</a> of file <a class="el" href="measure_8cpp_source.html">measure.cpp</a>.</p>

<p class="reference">References <a class="el" href="measure_8h_source.html#l00022">temperature::heater</a>, <a class="el" href="pinout_8h_source.html#l00027">HEATER_CS</a>, <a class="el" href="measure_8h_source.html#l00025">latest</a>, <a class="el" href="measure_8h_source.html#l00021">temperature::lower</a>, <a class="el" href="pinout_8h_source.html#l00026">LOWER_CS</a>, <a class="el" href="measure_8h_source.html#l00011">Rnom</a>, <a class="el" href="measure_8h_source.html#l00012">Rref</a>, <a class="el" href="measure_8h_source.html#l00009">sample_trigger</a>, <a class="el" href="measure_8h_source.html#l00020">temperature::upper</a>, and <a class="el" href="pinout_8h_source.html#l00025">UPPER_CS</a>.</p>

<p class="reference">Referenced by <a class="el" href="sapflow__protothread_8ino_source.html#l00047">loop()</a>.</p>

</div>
</div>
<a id="a4077648d56901b090710a429b69fe19d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4077648d56901b090710a429b69fe19d">&#9670;&nbsp;</a></span>sample_timer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sample_timer </td>
          <td>(</td>
          <td class="paramtype">struct pt *&#160;</td>
          <td class="paramname"><em>pt</em> = <code>&amp;<a class="el" href="measure_8h.html#ac1b4a8786e0684b0f63f527522e11e5e">sample_timer_thd</a></code></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Controls timing of the measurements. </p>
<p>This is a protothread that creates a pulse every second on the global variable sample_trigger in order to sychronize sample-based processing. Protothreads that sample or process sampled data can latch this signal using PT_WAIT_UNTIL(pt, sample_trigger); PT_WAIT_WHILE(pt, sample_trigger); to synchronize execution without impacting the sample frequency.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pt</td><td>A pointer to the protothread control structure. The default parameter is correct. Don't forget to initialize the control structure in <a class="el" href="sapflow__protothread_8ino.html#a4fc01d736fe50cf5b977f755b675f11d" title="One-time initialization.">setup()</a>. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the status of the protothread (Waiting, yeilded, exited, or ended) </dd></dl>

<p class="definition">Definition at line <a class="el" href="measure_8cpp_source.html#l00008">8</a> of file <a class="el" href="measure_8cpp_source.html">measure.cpp</a>.</p>

<p class="reference">References <a class="el" href="measure_8h_source.html#l00009">sample_trigger</a>.</p>

<p class="reference">Referenced by <a class="el" href="sapflow__protothread_8ino_source.html#l00047">loop()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="measure_8cpp.html">measure.cpp</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
